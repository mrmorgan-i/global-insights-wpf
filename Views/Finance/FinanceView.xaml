<UserControl x:Class="Global_Insights_Dashboard.Views.Finance.FinanceView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             xmlns:converters="clr-namespace:Global_Insights_Dashboard.Utils.Converters"
             Background="{DynamicResource MaterialDesignPaper}">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        
        <!-- Stock Button Style -->
        <Style x:Key="StockButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignOutlinedButton}">
            <Setter Property="Margin" Value="4" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Height" Value="32" />
        </Style>

        <!-- Favorite Button Style -->
        <Style x:Key="FavoriteButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
            <Setter Property="Margin" Value="2" />
            <Setter Property="Padding" Value="4" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="Height" Value="28" />
            <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}" />
            <Setter Property="Foreground" Value="{DynamicResource PrimaryHueDarkForegroundBrush}" />
        </Style>
    </UserControl.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <materialDesign:Card Grid.Row="0" Padding="20" Margin="0,0,0,20"
                           materialDesign:ElevationAssist.Elevation="Dp1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Title -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,16">
                    <materialDesign:PackIcon Kind="TrendingUp" Width="28" Height="28" 
                                           Foreground="{DynamicResource PrimaryHueMidBrush}" 
                                           VerticalAlignment="Center" />
                    <TextBlock Text="Stock Market" FontSize="24" FontWeight="Bold" 
                             Margin="12,0,0,0" VerticalAlignment="Center" />
                </StackPanel>

                <!-- Search Section -->
                <Grid Grid.Row="1" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBox Grid.Column="0"
                           Text="{Binding SymbolInput, UpdateSourceTrigger=PropertyChanged}"
                           materialDesign:HintAssist.Hint="Enter stock symbol (e.g., AAPL, MSFT)"
                           materialDesign:TextFieldAssist.HasClearButton="True"
                           Style="{StaticResource MaterialDesignFilledTextBox}"
                           Margin="0,0,12,0">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Enter" Command="{Binding GetQuoteDataCommand}" />
                        </TextBox.InputBindings>
                    </TextBox>

                    <Button Grid.Column="1"
                          Command="{Binding GetQuoteDataCommand}"
                          Style="{StaticResource MaterialDesignRaisedButton}"
                          Content="Get Quote"
                          Margin="0,0,8,0"
                          IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolToVisibilityConverter}}" />

                    <Button Grid.Column="2"
                          Command="{Binding AddToFavoritesCommand}"
                          Style="{StaticResource MaterialDesignIconButton}"
                          ToolTip="Add to favorites"
                          Width="40" Height="40">
                        <materialDesign:PackIcon Kind="Heart" />
                    </Button>
                </Grid>

                <!-- Popular Stocks -->
                <StackPanel Grid.Row="2" Margin="0,0,0,16">
                    <TextBlock Text="Popular Stocks:" FontWeight="SemiBold" 
                             Margin="0,0,0,8" FontSize="14" />
                    <ItemsControl ItemsSource="{Binding PopularStocks}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource StockButtonStyle}"
                                      Command="{Binding DataContext.LoadPopularStockCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                      CommandParameter="{Binding}"
                                      ToolTip="{Binding Name}">
                                    <TextBlock Text="{Binding Symbol}" FontWeight="SemiBold" />
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- Favorites -->
                <StackPanel Grid.Row="3" 
                          Visibility="{Binding FavoriteSymbols.Count, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="Your Favorites:" FontWeight="SemiBold" 
                             Margin="0,0,0,8" FontSize="14" />
                    <ItemsControl ItemsSource="{Binding FavoriteSymbols}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{DynamicResource PrimaryHueLightBrush}" 
                                      CornerRadius="16" Margin="4,2">
                                    <StackPanel Orientation="Horizontal" Margin="8,4">
                                        <TextBlock Text="{Binding}" FontSize="11" 
                                                 VerticalAlignment="Center"
                                                 Foreground="{DynamicResource PrimaryHueDarkForegroundBrush}" />
                                        <Button Style="{StaticResource MaterialDesignToolButton}"
                                              Command="{Binding DataContext.RemoveFromFavoritesCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              CommandParameter="{Binding}"
                                              Width="16" Height="16" Margin="4,0,0,0">
                                            <materialDesign:PackIcon Kind="Close" Width="10" Height="10" />
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Loading Indicator -->
        <materialDesign:Card Grid.Row="1" 
                           Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                           Padding="20" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                           IsIndeterminate="True" Width="32" Height="32" />
                <TextBlock Text="Loading stock data..." Margin="16,0,0,0" 
                         VerticalAlignment="Center" FontSize="16" />
            </StackPanel>
        </materialDesign:Card>

        <!-- Status Message -->
        <materialDesign:Card Grid.Row="1" 
                           Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"
                           Background="{DynamicResource MaterialDesignValidationErrorBrush}"
                           Padding="16" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <materialDesign:PackIcon Kind="AlertCircle" 
                                       VerticalAlignment="Center" 
                                       Foreground="White" 
                                       Width="24" Height="24" />
                <TextBlock Text="{Binding ErrorMessage}" 
                         Margin="12,0,0,0"
                         Foreground="White"
                         VerticalAlignment="Center" 
                         FontSize="14"
                         TextWrapping="Wrap" />
            </StackPanel>
        </materialDesign:Card>

        <!-- Content Area -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                
                <!-- No Data Message -->
                <materialDesign:Card Visibility="{Binding HasQuoteData, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                                   Padding="40" HorizontalAlignment="Center">
                    <StackPanel HorizontalAlignment="Center">
                        <materialDesign:PackIcon Kind="ChartLine" Width="64" Height="64" 
                                               Foreground="{DynamicResource MaterialDesignBodyLight}" 
                                               HorizontalAlignment="Center" />
                        <TextBlock Text="No stock data available" 
                                 FontSize="18" Margin="0,16,0,8"
                                 HorizontalAlignment="Center"
                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                        <TextBlock Text="Enter a stock symbol to get started"
                                 FontSize="14" HorizontalAlignment="Center"
                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                    </StackPanel>
                </materialDesign:Card>

                <!-- Stock Quote Data -->
                <StackPanel Visibility="{Binding HasQuoteData, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <!-- Quote Summary -->
                    <materialDesign:Card Padding="20" Margin="0,0,0,16"
                                       materialDesign:ElevationAssist.Elevation="Dp2">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <TextBlock Text="{Binding CurrentQuote.Quote.Symbol}" 
                                             FontSize="24" FontWeight="Bold" />
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                    <TextBlock Text="{Binding CurrentQuote.Quote.Price, StringFormat=${0:F2}}" 
                                             FontSize="32" FontWeight="Bold"
                                             Foreground="{DynamicResource PrimaryHueMidBrush}" />
                                    <StackPanel Margin="16,0,0,0" VerticalAlignment="Bottom">
                                        <TextBlock Text="{Binding CurrentQuote.Quote.Change, StringFormat={}{0:+0.00;-0.00;0.00}}" 
                                                 FontSize="16" FontWeight="SemiBold" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.ChangePercent, StringFormat=({0:+0.00;-0.00;0.00}%)}" 
                                                 FontSize="14" />
                                    </StackPanel>
                                </StackPanel>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!-- Market Data -->
                                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,24,8">
                                        <TextBlock Text="Open" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.Open, StringFormat=${0:F2}}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,24,8">
                                        <TextBlock Text="High" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.High, StringFormat=${0:F2}}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,24,8">
                                        <TextBlock Text="Low" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.Low, StringFormat=${0:F2}}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Row="0" Grid.Column="3" Margin="0,0,0,8">
                                        <TextBlock Text="Volume" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.Volume, StringFormat={}{0:N0}}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,24,0">
                                        <TextBlock Text="Previous Close" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.PreviousClose, StringFormat=${0:F2}}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>

                                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="0,0,24,0">
                                        <TextBlock Text="Trading Date" FontSize="12" 
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}" />
                                        <TextBlock Text="{Binding CurrentQuote.Quote.LatestTradingDay}" 
                                                 FontSize="14" FontWeight="SemiBold" />
                                    </StackPanel>
                                </Grid>
                            </StackPanel>

                            <Button Grid.Column="1"
                                  Command="{Binding RefreshDataCommand}"
                                  Style="{StaticResource MaterialDesignIconButton}"
                                  ToolTip="Refresh data"
                                  Width="40" Height="40" VerticalAlignment="Top">
                                <materialDesign:PackIcon Kind="Refresh" />
                            </Button>
                        </Grid>
                    </materialDesign:Card>

                    <!-- Price Chart -->
                    <materialDesign:Card Padding="20" Margin="0,0,0,16"
                                       materialDesign:ElevationAssist.Elevation="Dp2"
                                       Visibility="{Binding ShowChart, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Text="30-Day Price Chart" FontSize="18" FontWeight="SemiBold" 
                                     Margin="0,0,0,16" />
                            
                            <lvc:CartesianChart Series="{Binding PriceSeries}"
                                              XAxes="{Binding XAxes}"
                                              YAxes="{Binding YAxes}"
                                              Height="300"
                                              AnimationsSpeed="0:0:0.5" />
                        </StackPanel>
                    </materialDesign:Card>
                    
                    <!-- Last Updated Info -->
                    <TextBlock Text="{Binding LastUpdated, StringFormat='Last updated: {0:MMM dd, yyyy HH:mm}'}"
                             FontSize="12" Margin="0,8,0,0"
                             HorizontalAlignment="Center"
                             Foreground="{DynamicResource MaterialDesignBodyLight}" />
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
